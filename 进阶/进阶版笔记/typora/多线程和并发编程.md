## å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹ç®€ä»‹

### å¤šè¿›ç¨‹æ¦‚å¿µ

- å½“å‰çš„æ“ä½œç³»ç»Ÿéƒ½æ˜¯å¤šä»»åŠ¡OSï¼Œæ¯ä¸ªç‹¬ç«‹æ‰§è¡Œçš„ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚

- OSå°†æ—¶é—´åˆ’åˆ†ä¸ºå¤šä¸ªæ—¶é—´ç‰‡ï¼ˆæ—¶é—´å¾ˆçŸ­ï¼‰ï¼Œæ¯ä¸ªæ—¶é—´ç‰‡å†…å°†CPUåˆ†é…ç»™æŸä¸€ä¸ªä»»åŠ¡ï¼Œæ—¶é—´ç‰‡ç»“æŸï¼ŒCPUå°†è‡ªåŠ¨å›æ”¶ï¼Œå†åˆ†é…ç»™å¦å¤–ä»»åŠ¡ã€‚ä»å¤–éƒ¨çœ‹ï¼Œæ‰€æœ‰ä»»åŠ¡æ˜¯åŒæ—¶åœ¨æ‰§è¡Œã€‚ä½†æ˜¯åœ¨CPUä¸Šï¼Œä»»åŠ¡æ˜¯æŒ‰ç…§ä¸²è¡Œä¾æ¬¡è¿è¡Œï¼ˆå•æ ¸CPUï¼‰ã€‚å¦‚æœæ˜¯å¤šæ ¸ï¼Œå¤šä¸ªè¿›ç¨‹ä»»åŠ¡å¯ä»¥å¹¶è¡Œã€‚ä½†æ˜¯å•ä¸ªæ ¸ä¸Šï¼Œå¤šè¿›ç¨‹åªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚

- å¤šè¿›ç¨‹çš„ä¼˜ç‚¹

  - å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡
  - ç¨‹åºå› IOå µå¡æ—¶ï¼Œå¯ä»¥é‡Šæ”¾CPUï¼Œè®©CPUä¸ºå…¶ä»–ç¨‹åºæœåŠ¡
  - å½“ç³»ç»Ÿæœ‰å¤šä¸ªCPUæ—¶ï¼Œå¯ä»¥ä¸ºå¤šä¸ªç¨‹åºåŒæ—¶æœåŠ¡
    - æˆ‘ä»¬çš„CPUä¸å†æé«˜é¢‘ç‡ï¼Œè€Œæ˜¯æé«˜æ ¸æ•°
    - 2005å¹´Herb Sutterçš„æ–‡ç«  The free lunch is overï¼ŒæŒ‡æ˜å¤šæ ¸å’Œå¹¶è¡Œç¨‹åºæ‰æ˜¯æé«˜ç¨‹åºæ€§èƒ½çš„å”¯ä¸€åŠæ³•

- å¤šè¿›ç¨‹çš„ç¼ºç‚¹

  - å¤ªç¬¨é‡ï¼Œä¸å¥½ç®¡ç†

- å¤ªç¬¨é‡ï¼Œä¸å¥½åˆ‡æ¢

   

### å¤šçº¿ç¨‹æ¦‚å¿µ

- ä¸€ä¸ªç¨‹åºå¯ä»¥åŒ…æ‹¬å¤šä¸ªå­ä»»åŠ¡ï¼Œå¯ä¸²/å¹¶è¡Œï¼Œæ¯ä¸ªå­ä»»åŠ¡å¯ä»¥ç§°ä¸ºä¸€ä¸ªçº¿ç¨‹
- å¦‚æœä¸€ä¸ªå­ä»»åŠ¡é˜»å¡ï¼Œç¨‹åºå¯ä»¥å°†CPUè°ƒåº¦å¦å¤–ä¸€ä¸ªå­ä»»åŠ¡è¿›è¡Œå·¥ä½œã€‚è¿™æ ·CPUè¿˜æ˜¯ä¿ç•™åœ¨æœ¬ç¨‹åºä¸­ï¼Œè€Œä¸æ˜¯è¢«è°ƒåº¦åˆ°åˆ«çš„ç¨‹åº(è¿›ç¨‹)å»ã€‚è¿™æ ·ï¼Œæé«˜æœ¬ç¨‹åºæ‰€è·å¾—CPUæ—¶é—´å’Œåˆ©ç”¨ç‡ã€‚

### å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹å¯¹æ¯”

- çº¿ç¨‹å…±äº«æ•°æ®
- çº¿ç¨‹é€šè®¯æ›´é«˜æ•ˆ
- çº¿ç¨‹æ›´è½»é‡çº§ï¼Œæ›´å®¹æ˜“åˆ‡æ¢
- å¤šä¸ªçº¿ç¨‹æ›´å®¹æ˜“ç®¡ç†

## Javaå¤šçº¿ç¨‹å®ç°

### Java å¤šçº¿ç¨‹åˆ›å»º

java.lang.Threadï¼šçº¿ç¨‹ç»§æ‰¿Threadç±»ï¼Œå®ç°runæ–¹æ³•

```java
public class Thread1 extends Thread{
	public void run()
	{
		System.out.println("hello");
	}
}
```

java.lang.Runnableæ¥å£ï¼šçº¿ç¨‹å®ç°Runnableæ¥å£ï¼Œå®ç°runæ–¹æ³•

```java
public class Thread2 implements Runnable{
	public void run()
	{
		System.out.println("hello");
	}
}
```

> Javaçš„å››ä¸ªä¸»è¦æ¥å£ï¼š
> Clonableï¼Œç”¨äºå¯¹è±¡å…‹éš†
> Comparableï¼Œç”¨äºå¯¹è±¡æ¯”è¾ƒ
> Serializableï¼Œç”¨äºå¯¹è±¡åºåˆ—åŒ–
> Runnableï¼Œç”¨äºå¯¹è±¡çº¿ç¨‹åŒ–

#### Java å¤šçº¿ç¨‹å¯åŠ¨

> Threadæ–¹å¼ï¼š
>
> â€‹	å¯ä»¥æä¾›è¿‡ç»§æ‰¿Threadç±»æ¥åˆ›å»ºçº¿ç¨‹ã€‚
> â€‹	é€šè¿‡startæ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹çš„runæ–¹æ³•ã€‚

```java
public class Thread1 extends Thread{
	public void run()
	{
		System.out.println("hello");
	}
	public static void main(String[] a)
	{
		new Thread1().start();
	}
}


```



>  Runnableæ–¹æ³•ï¼š
>
> å¯ä»¥é€šè¿‡å®ç°Runnableæ¥å£æ¥åˆ›å»ºçº¿ç¨‹
> å®ç°Runnableçš„å¯¹è±¡å¿…é¡»åŒ…è£…åœ¨Threadç±»é‡Œé¢ï¼Œæ‰å¯ä»¥å¯åŠ¨ï¼›ä¸èƒ½ç›´æ¥å¯¹Runnableçš„å¯¹è±¡è¿›è¡Œstartæ–¹æ³•ã€‚
> é€šè¿‡startæ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹çš„runæ–¹æ³•

```java
public class Thread2 implements Runnable{	
	public void run()
	{
		System.out.println("hello");
	}
	public static void main(String[] a)
	{
		new Thread(new Thread2()).start();
	}
}

```

> ç¬¬ä¸€æ¡è§„åˆ™ï¼š
>
> è°ƒç”¨runæ–¹æ³•æ¥å¯åŠ¨runæ–¹æ³•ï¼Œå°†ä¼šæ˜¯ä¸²è¡Œè¿è¡Œã€‚
> è°ƒç”¨startæ–¹æ³•æ¥å¯åŠ¨runæ–¹æ³•ï¼Œå°†ä¼šæ˜¯å¹¶è¡Œè¿è¡Œã€‚

```java
public class ThreadDemo0
{
	public static void main(String args[]) throws Exception
	{
		//new TestThread0().run(); //ä¸²è¡Œ
		new TestThread0().start();  //å¹¶è¡Œ
		while(true)
		{
			System.out.println("main thread is running");
			Thread.sleep(10);
		}
	}
}
 class TestThread0  	
{
	public void run() 
	{
		while(true)
		{
			System.out.println(" TestThread1 is running");
			try {
				Thread.sleep(1000); //1000æ¯«ç§’
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
} 
```



>  ç¬¬äºŒæ¡è§„åˆ™ï¼š
>
> mainçº¿ç¨‹å¯èƒ½æ—©äºå­çº¿ç¨‹ç»“æŸã€‚
> mainçº¿ç¨‹å’Œå­çº¿ç¨‹éƒ½ç»“æŸäº†ï¼Œæ•´ä¸ªç¨‹åºæ‰ç®—ç»ˆæ­¢ã€‚

```java
public class ThreadDemo2
{
	public static void main(String args[]) throws InterruptedException
	{
		new TestThread2().start();
//		while(true)
//		{
//			System.out.println("main thread is running");
//			Thread.sleep(1000);
//		}
	}
}
 class TestThread2 extends Thread
{
	public void run() 
	{
		while(true)
		{
			System.out.println("TestThread2" + 
			"ã€€is running");
			try {
				Thread.sleep(1000);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
} 
```





> ç¬¬ä¸‰æ¡è§„åˆ™ï¼š
>
> å®ç°Runnableçš„å¯¹è±¡å¿…é¡»åŒ…è£…åœ¨Threadç±»é‡Œé¢ï¼Œæ‰å¯ä»¥å¯åŠ¨ã€‚
> ä¸èƒ½ç›´æ¥å¯¹Runnableçš„å¯¹è±¡è¿›è¡Œstartæ–¹æ³•ã€‚

```java
public class ThreadDemo3
{
	public static void main(String args[])
	{
		//new TestThread3().start();
		//Runnableå¯¹è±¡å¿…é¡»æ”¾åœ¨ä¸€ä¸ªThreadç±»ä¸­æ‰èƒ½è¿è¡Œ
		TestThread3 tt= new TestThread3();//åˆ›å»ºTestThreadç±»çš„ä¸€ä¸ªå®ä¾‹
		Thread t= new Thread(tt);//åˆ›å»ºä¸€ä¸ªThreadç±»çš„å®ä¾‹
		t.start();//ä½¿çº¿ç¨‹è¿›å…¥RunnableçŠ¶æ€
		while(true)
		{
			System.out.println("main thread is running");
			try {
				Thread.sleep(1000); //1000æ¯«ç§’
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
}
class TestThread3 implements Runnable //extends Thread
{
	//çº¿ç¨‹çš„ä»£ç æ®µï¼Œå½“æ‰§è¡Œstart()æ—¶ï¼Œçº¿ç¨‹ä»æ­¤å‡ºå¼€å§‹æ‰§è¡Œ
	public void run()
	{
		while(true)
		{
			System.out.println(Thread.currentThread().getName() +
			" is running");
			try {
				Thread.sleep(1000); //1000æ¯«ç§’
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
}

```

> ç¬¬å››æ¡è§„åˆ™ï¼š
>
> ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ä¸èƒ½å¤šæ¬¡startï¼Œå¤šæ¬¡startå°†æŠ¥å¼‚å¸¸ã€‚
> å¤šä¸ªçº¿ç¨‹å¯¹è±¡éƒ½startåï¼Œå“ªä¸€ä¸ªå…ˆæ‰§è¡Œï¼Œå®Œå…¨ç”±JVM/æ“ä½œç³»ç»Ÿæ¥ä¸»å¯¼ï¼Œç¨‹åºå‘˜æ— æ³•æŒ‡å®šã€‚

```java
public class ThreadDemo4
{
	public static void main(String [] args)
	{
		TestThread4 t=new TestThread4();
		t.start();
		//t.start();
		//t.start();
		//t.start();
		TestThread4 t1=new TestThread4();
		t1.start();		
	}
}

class TestThread4 extends Thread  
{
	public void run()
	{
		while(true)
		{
			System.out.println(Thread.currentThread().getName() +
			" is running");
			try {
				Thread.sleep(1000); //1000æ¯«ç§’
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
}
```



### Java å¤šçº¿ç¨‹å®ç°å¯¹æ¯”

- Threadå æ®äº†çˆ¶ç±»çš„åé¢ï¼Œä¸å¦‚Runnableæ–¹ä¾¿
- Thread ç±»å®ç°Runnable
- Runnableå¯åŠ¨æ—¶éœ€è¦Threadç±»çš„æ”¯æŒ
- Runnable æ›´å®¹æ˜“å®ç°å¤šçº¿ç¨‹ä¸­èµ„æºå…±äº«
- ç»“è®ºï¼šå»ºè®®å®ç°Runnableæ¥å£æ¥å®Œæˆå¤šçº¿ç¨‹





## Javaå¤šçº¿ç¨‹ä¿¡æ¯å…±äº«

- çº¿ç¨‹ç±»
  - é€šè¿‡ç»§æ‰¿Threadæˆ–å®ç°Runnable
  - é€šè¿‡startæ–¹æ³•ï¼Œè°ƒç”¨runæ–¹æ³•ï¼Œ runæ–¹æ³•å·¥ä½œ
  - çº¿ç¨‹runç»“æŸåï¼Œçº¿ç¨‹é€€å‡º
- ç²—ç²’åº¦ï¼šå­çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´ã€å’Œmainçº¿ç¨‹ä¹‹é—´ç¼ºä¹äº¤æµ
- ç»†ç²’åº¦ï¼šçº¿ç¨‹ä¹‹é—´æœ‰ä¿¡æ¯äº¤æµé€šè®¯
  - é€šè¿‡å…±äº«å˜é‡è¾¾åˆ°ä¿¡æ¯å…±äº«
  - JDKåŸç”Ÿåº“æš‚ä¸æ”¯æŒå‘é€æ¶ˆæ¯ (ç±»ä¼¼MPIå¹¶è¡Œåº“ç›´æ¥å‘é€æ¶ˆæ¯)



### staticå˜é‡

åŒä¸€ä¸ªRunnableç±»çš„æˆå‘˜å˜é‡æ¥è¾¾åˆ°å…±äº«ã€‚



**ç¤ºä¾‹ä»£ç ï¼ˆçº¿ç¨‹å–ç›˜ï¼‰**

```java
public class ThreadDemo0
{
	public static void main(String [] args)
	{
		new TestThread0().start();
		new TestThread0().start();
		new TestThread0().start();
		new TestThread0().start();
	}
}
class TestThread0 extends Thread  
{
	//private int tickets=100;           //æ¯ä¸ªçº¿ç¨‹å–100å¼ ï¼Œæ²¡æœ‰å…±äº«
	private static int tickets=100;  //staticå˜é‡æ˜¯å…±äº«çš„ï¼Œæ‰€æœ‰çš„çº¿ç¨‹å…±äº«
	public void run()
	{
		while(true)
		{
			if(tickets>0)
			{
				System.out.println(Thread.currentThread().getName() +
				" is selling ticket " + tickets);
				tickets = tickets - 1;
			}
			else
			{
				break;
			}
		}
	}
}

```

éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721145700087.png" alt="image-20210721145700087" style="zoom:50%;" />



### æ™®é€šæˆå‘˜å˜é‡

**ç¤ºä¾‹ä»£ç **

```java
public class ThreadDemo1
{
	public static void main(String [] args)
	{
		TestThread1 t=new TestThread1();
		new Thread(t).start();
		new Thread(t).start();
		new Thread(t).start();
		new Thread(t).start();
	}
}
class TestThread1 implements Runnable
{
	private int tickets=100;
	public void run()
	{
		while(true)
		{
			if(tickets>0)
			{
				try {
					Thread.sleep(100);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
				tickets--;
				System.out.println(Thread.currentThread().getName() +" is selling ticket " + tickets);
			}
			else
			{
				break;
			}
				

		}
	}

}
```





> TestThread1åªè¢«åˆ›å»ºä¸€æ¬¡ï¼Œå°±æ˜¯tã€‚
> è€Œnew Threadï¼ˆtï¼‰å¹¶æ²¡æœ‰åˆ›å»ºTestThread1å¯¹è±¡ï¼Œè€Œæ˜¯æŠŠtåŒ…è£…æˆçº¿ç¨‹å¯¹è±¡ï¼Œç„¶åå¯åŠ¨ã€‚
> ç¬¬7è¡Œåˆ°ç¬¬10è¡Œä»£ç ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªTestThread1çš„å¯¹è±¡tã€‚

éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721145813034.png" alt="image-20210721145813034" style="zoom:50%;" />

### å­˜åœ¨é—®é¢˜

- å·¥ä½œç¼“å­˜å‰¯æœ¬
  - æŸçº¿ç¨‹ä¿®æ”¹äº†è‡ªå·±å·¥ä½œç¼“å­˜ä¸­çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹å¹¶ä¸çŸ¥æ™“ï¼Œç»§ç»­ç”¨è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­çš„å€¼ï¼Œä½†è¯¥å€¼ä¸èƒ½åæ˜ æœ€æ–°çš„å˜é‡å€¼ï¼Œå¤§å®¶éƒ½æ˜¯ç”¨çš„å‰ä¸€åˆ»å˜é‡å€¼ã€‚
- å…³é”®æ­¥éª¤ï¼ˆä¸´ç•ŒåŒºï¼‰ç¼ºä¹åŠ é”é™åˆ¶
  ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å¯¹æŸä¸€å˜é‡è¿›è¡Œä¿®æ”¹æ“ä½œã€‚

#### volatileå…³é”®å­—

é‡‡ç”¨volatile å…³é”®å­—ä¿®é¥°å˜é‡ï¼Œä¿è¯ä¸åŒçº¿ç¨‹å¯¹å…±äº«å˜é‡æ“ä½œæ—¶çš„å¯è§æ€§ã€‚

**ç¤ºä¾‹ä»£ç **

```java
public class ThreadDemo2
{
	public static void main(String args[]) throws Exception 
	{
		TestThread2 t = new TestThread2();
		t.start();
		Thread.sleep(2000);
		t.flag = false;
		System.out.println("main thread is exiting");
	}
}

class TestThread2 extends Thread
{
	//boolean flag = true;   //å­çº¿ç¨‹ä¸ä¼šåœæ­¢
	volatile boolean flag = true;  //ç”¨volatileä¿®é¥°çš„å˜é‡å¯ä»¥åŠæ—¶åœ¨å„çº¿ç¨‹é‡Œé¢é€šçŸ¥
	public void run() 
	{
		int i=0;
		while(flag)
		{
			i++;			
		}
		System.out.println("test thread3 is exiting");
	}	
}

```


è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721145943165.png" alt="image-20210721145943165" style="zoom:50%;" />



### å…³é”®æ­¥éª¤åŠ é”

- å…³é”®æ­¥éª¤åŠ é”é™åˆ¶
  - äº’æ–¥ï¼šæŸä¸€ä¸ªçº¿ç¨‹è¿è¡Œä¸€ä¸ªä»£ç æ®µ(å…³é”®åŒº)ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åŒæ—¶è¿è¡Œè¿™ä¸ªä»£ç æ®µ
  - åŒæ­¥ï¼šå¤šä¸ªçº¿ç¨‹çš„è¿è¡Œï¼Œå¿…é¡»æŒ‰ç…§æŸä¸€ç§è§„å®šçš„å…ˆåé¡ºåºæ¥è¿è¡Œ
  - äº’æ–¥æ˜¯åŒæ­¥çš„ä¸€ç§ç‰¹ä¾‹
- äº’æ–¥çš„å…³é”®å­—æ˜¯synchronized
  - synchronizedä»£ç å—/å‡½æ•°ï¼Œåªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥
  - synchronizedåŠ å¤§æ€§èƒ½è´Ÿæ‹…ï¼Œä½†æ˜¯ä½¿ç”¨ç®€ä¾¿



**ç¤ºä¾‹ä»£ç **

```java
public class ThreadDemo3 {
	public static void main(String[] args) {
		TestThread3 t = new TestThread3();
		new Thread(t, "Thread-0").start();
		new Thread(t, "Thread-1").start();
		new Thread(t, "Thread-2").start();
		new Thread(t, "Thread-3").start();
	}
}

class TestThread3 implements Runnable {
	private volatile int tickets = 100; // å¤šä¸ª çº¿ç¨‹åœ¨å…±äº«çš„
	String str = new String("");

	public void run() {
		while (true) {
			synchronized(str){   //åŒæ­¥ä»£ç å—
				sale();
			}
			try {
				Thread.sleep(100);
			} catch (Exception e) {
				System.out.println(e.getMessage());
			}
			if (tickets <= 0) {
				break;
			}
		}
	
	}
	
	public synchronized void sale() { // åŒæ­¥å‡½æ•°
		if (tickets > 0) {
			System.out.println(Thread.currentThread().getName() + " is saling ticket " + tickets--);
		}
	}

}

```


éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721150044196.png" alt="image-20210721150044196" style="zoom:67%;" />

## Javaå¤šçº¿ç¨‹ç®¡ç†

### çº¿ç¨‹çŠ¶æ€

- NEW åˆšåˆ›å»º(new)
- RUNNABLE å°±ç»ªæ€(start)
- RUNNING è¿è¡Œä¸­(run)
- BLOCK é˜»å¡(sleep)
- TERMINATED ç»“æŸ



- Threadçš„éƒ¨åˆ†APIå·²ç»åºŸå¼ƒ
  - æš‚åœå’Œæ¢å¤ suspend/resume
  - æ¶ˆäº¡ stop/destroy
- çº¿ç¨‹é˜»å¡å’Œå”¤é†’
  - sleepï¼Œæ—¶é—´ä¸€åˆ°ï¼Œè‡ªå·±ä¼šé†’æ¥
  - wait/notify/notifyAllï¼Œç­‰å¾…ï¼Œéœ€è¦åˆ«äººæ¥å”¤é†’ï¼ˆä¸è¢«å”¤é†’åˆ™ä¸€ç›´ç­‰å¾…ï¼‰
  - joinï¼Œç­‰å¾…å¦å¤–ä¸€ä¸ªçº¿ç¨‹ç»“æŸ
  - interruptï¼Œå‘å¦å¤–ä¸€ä¸ªçº¿ç¨‹å‘é€ä¸­æ–­ä¿¡å·ï¼Œè¯¥çº¿ç¨‹æ”¶åˆ°ä¿¡å·ï¼Œä¼šè§¦å‘InterruptedException(å¯è§£é™¤é˜»å¡)ï¼Œå¹¶è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†



### ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜

> ç”Ÿäº§è€…ä¸æ–­çš„å¾€ä»“åº“ä¸­å­˜æ”¾äº§å“ï¼Œæ¶ˆè´¹è€…ä»ä»“åº“ä¸­æ¶ˆè´¹äº§å“ã€‚
> å…¶ä¸­ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½å¯ä»¥æœ‰è‹¥å¹²ä¸ªã€‚
> ä»“åº“è§„åˆ™ï¼šå®¹é‡æœ‰é™ï¼Œåº“æ»¡æ—¶ä¸èƒ½å­˜æ”¾ï¼Œåº“ç©ºæ—¶ä¸èƒ½å–äº§å“ ã€‚
>

**ä¸»ç±»**

```java
package product;
public class ProductTest {
	public static void main(String[] args) throws InterruptedException {
		Storage storage = new Storage();
		

		Thread consumer1 = new Thread(new Consumer(storage));
		consumer1.setName("æ¶ˆè´¹è€…1");
		Thread consumer2 = new Thread(new Consumer(storage));
		consumer2.setName("æ¶ˆè´¹è€…2");
		Thread producer1 = new Thread(new Producer(storage));
		producer1.setName("ç”Ÿäº§è€…1");
		Thread producer2 = new Thread(new Producer(storage));
		producer2.setName("ç”Ÿäº§è€…2");
		
		producer1.start();
		producer2.start();
		Thread.sleep(1000);		
		consumer1.start();
		consumer2.start();		
	}

}
```

**ä»“åº“**

```java
package product;
/**
 *ä»“åº“
 */
class Storage {
	// ä»“åº“å®¹é‡ä¸º10
	private Product[] products = new Product[10];
	private int top = 0;

	// ç”Ÿäº§è€…å¾€ä»“åº“ä¸­æ”¾å…¥äº§å“
	public synchronized void push(Product product) {
		while (top == products.length) {
			try {
				System.out.println("producer wait");
				wait();//ä»“åº“å·²æ»¡ï¼Œç­‰å¾…
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	    //æŠŠäº§å“æ”¾å…¥ä»“åº“
		products[top++] = product;
		System.out.println(Thread.currentThread().getName() + " ç”Ÿäº§äº†äº§å“"
				+ product);
		System.out.println("producer notifyAll");
		notifyAll();//å”¤é†’ç­‰å¾…çº¿ç¨‹
	}
	
	// æ¶ˆè´¹è€…ä»ä»“åº“ä¸­å–å‡ºäº§å“
	public synchronized Product pop() {
		while (top == 0) {
			try {
				System.out.println("consumer wait");
				wait();//ä»“åº“ç©ºï¼Œç­‰å¾…
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	
		//ä»ä»“åº“ä¸­å–äº§å“
		--top;
		Product p = new Product(products[top].getId(), products[top].getName());
		products[top] = null;
		System.out.println(Thread.currentThread().getName() + " æ¶ˆè´¹äº†äº§å“" + p);
		System.out.println("comsumer notifyAll");
		notifyAll();//å”¤é†’ç­‰å¾…çº¿ç¨‹
		return p;
	}

}
```

**äº§å“ç±»**

```java
package product;

/**

 * äº§å“ç±»
   */
   class Product {
   private int id;// äº§å“id
   private String name;// äº§å“åç§°

   public Product(int id, String name) {
   	this.id = id;
   	this.name = name;
   }
   public String toString() {
   	return "(äº§å“IDï¼š" + id + " äº§å“åç§°ï¼š" + name + ")";
   }
   public int getId() {
   	return id;
   }
   public void setId(int id) {
   	this.id = id;
   }
   public String getName() {
   	return name;
   }
   public void setName(String name) {
   	this.name = name;
   }
   }
```



**ç”Ÿäº§è€…**

```java
package product;

import java.util.Random;

/**

 * ç”Ÿäº§è€…
   */
   class Producer implements Runnable {
   private Storage storage;

   public Producer(Storage storage) {
   	this.storage = storage;
   }

   @Override
   public void run() {
   	int i = 0;
   	Random r = new Random();
   	while(i<10)
   	{
   		i++;
   		Product product = new Product(i, "ç”µè¯" + r.nextInt(100));
   		storage.push(product);
   	}		
   }
   }
   
```

**æ¶ˆè´¹è€…**

```java
package product;

/**

 * æ¶ˆè´¹è€…
   */
   class Consumer implements Runnable {
   private Storage storage;

   public Consumer(Storage storage) {
   	this.storage = storage;
   }

   public void run() {
   	int i = 0;
   	while(i<10)
   	{
   		i++;
   		storage.pop();
   		try {
   			Thread.sleep(100);
   		} catch (InterruptedException e) {
   			e.printStackTrace();
   		}
   	}
   	
   }
   }
```



è¯¥ç¤ºä¾‹ä¸­ä¸¤ä¸ªç”Ÿäº§è€…åˆ†åˆ«ç”Ÿäº§10ä¸ªäº§å“ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«æ¶ˆè´¹10ä¸ªäº§å“ã€‚

éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721150401747.png" alt="image-20210721150401747" style="zoom:80%;" />



### çº¿ç¨‹è¦åšè‡ªå·±çš„ä¸»

- çº¿ç¨‹è¢«åŠ¨åœ°æš‚åœå’Œç»ˆæ­¢
  - ä¾é åˆ«çš„çº¿ç¨‹æ¥æ‹¯æ•‘è‡ªå·± ğŸ˜•ğŸ˜•ğŸ˜•
  - æ²¡æœ‰åŠæ—¶é‡Šæ”¾èµ„æº
- çº¿ç¨‹ä¸»åŠ¨æš‚åœå’Œç»ˆæ­¢
  - å®šæœŸç›‘æµ‹å…±äº«å˜é‡
  - å¦‚æœéœ€è¦æš‚åœæˆ–è€…ç»ˆæ­¢ï¼Œå…ˆé‡Šæ”¾èµ„æºï¼Œå†ä¸»åŠ¨åŠ¨ä½œ ğŸ˜ŠğŸ˜ŠğŸ˜Š
  - æš‚åœï¼šThread.sleep()ï¼Œä¼‘çœ 
  - ç»ˆæ­¢ï¼šrunæ–¹æ³•ç»“æŸï¼Œçº¿ç¨‹ç»ˆæ­¢

**ç¤ºä¾‹ä»£ç **

```java
package interrupt;

public class InterruptTest {

	public static void main(String[] args) throws InterruptedException {
		TestThread1 t1 = new TestThread1();
		TestThread2 t2 = new TestThread2();
	
		t1.start();
		t2.start();
	
		// è®©çº¿ç¨‹è¿è¡Œä¸€ä¼šå„¿åä¸­æ–­
		Thread.sleep(2000);
		t1.interrupt();
		t2.flag = false;
		System.out.println("main thread is exiting");
	}

}

class TestThread1 extends Thread {
	public void run() {
		// åˆ¤æ–­æ ‡å¿—ï¼Œå½“æœ¬çº¿ç¨‹è¢«åˆ«äººinterruptåï¼ŒJVMä¼šè¢«æœ¬çº¿ç¨‹è®¾ç½®interruptedæ ‡è®°
		while (!interrupted()) {
			System.out.println("test thread1 is running");
			try {
				Thread.sleep(1000);
			} catch (InterruptedException e) {
				e.printStackTrace();
				break;
			}
		}
		System.out.println("test thread1 is exiting");
	}
}

class TestThread2 extends Thread {
	public volatile boolean flag = true;
	public void run() {
		// åˆ¤æ–­æ ‡å¿—ï¼Œå½“æœ¬çº¿ç¨‹è¢«åˆ«äººinterruptåï¼ŒJVMä¼šè¢«æœ¬çº¿ç¨‹è®¾ç½®interruptedæ ‡è®°
		while (flag) {
			System.out.println("test thread2 is running");
			try {
				Thread.sleep(1000);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
		System.out.println("test thread2 is exiting");
	}
}
```





> interrupted() æ˜¯Threadç±»çš„æ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯•å½“å‰çº¿ç¨‹æ˜¯å¦æ”¶åˆ°ä¸€ä¸ªINTERRUPTä¿¡å·ã€‚
> å¦‚æœæ”¶åˆ°ï¼Œè¯¥æ–¹æ³•è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721150735557.png" alt="image-20210721150735557" style="zoom:67%;" />

#### ä¸¤ç§æ–¹å¼æ¯”è¾ƒï¼š

ç”¨interruptè¿™ä¸ªæ ‡å¿—æ¥ä¸­æ–­å¼‚å¸¸çš„è¯ï¼Œéœ€è¦è‡ªå·±å»æ·»åŠ å¼‚å¸¸å¤„ç†ï¼Œå¹¶ä¸”æ­¤å¤„çš„å¼‚å¸¸å¯èƒ½ä¼šè®©ä½ æ¥ä¸åŠé‡Šæ”¾èµ„æºã€‚
å®šæœŸå»ç›‘æµ‹flagå˜é‡ï¼Œå½“å˜é‡è¢«ä¿®æ”¹äº†ï¼Œå°±å¯ä»¥å¾ˆä¼˜é›…åœ°é‡Šæ”¾æ‰€æœ‰èµ„æºï¼Œç„¶åä¸»åŠ¨é€€å‡ºã€‚

### å¤šçº¿ç¨‹æ­»é”

- æ¯ä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰åˆ«äººéœ€è¦çš„é”(å“²å­¦å®¶åƒé¢é—®é¢˜)
- é¢„é˜²æ­»é”ï¼Œå¯¹èµ„æºè¿›è¡Œç­‰çº§æ’åº

> æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚



**ç¤ºä¾‹ä»£ç **

```java
package deadlock;

import java.util.concurrent.TimeUnit;

public class ThreadDemo5
{
	public static Integer r1 = 1;
	public static Integer r2 = 2;
	public static void main(String args[]) throws InterruptedException
	{
		TestThread51 t1 = new TestThread51();
		t1.start();
		TestThread52 t2 = new TestThread52();
		t2.start();
	}
}

class TestThread51 extends Thread
{
	public void run() 
	{
		//å…ˆè¦r1,å†è¦r2
		synchronized(ThreadDemo5.r1)
		{
			try {
				TimeUnit.SECONDS.sleep(3);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
			synchronized(ThreadDemo5.r2)
			{
				System.out.println("TestThread51 is running");
			}
		}
	}
} 
class TestThread52 extends Thread
{
	public void run() 
	{
		//å…ˆè¦r2,å†è¦r1
		synchronized(ThreadDemo5.r2)
		{
			try {
				TimeUnit.SECONDS.sleep(3);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
			synchronized(ThreadDemo5.r1)
			{
				System.out.println("TestThread52 is running");
			}
		}
	}
}
```

> TimeUnitæ˜¯JDK 5å¼•å…¥çš„æ–°ç±»
> ä½äºjava.util.concurrentåŒ…ä¸­ã€‚
> å®ƒæä¾›äº†æ—¶é—´å•ä½ç²’åº¦å’Œä¸€äº›æ—¶é—´è½¬æ¢ã€è®¡æ—¶å’Œå»¶è¿Ÿç­‰å‡½æ•°ã€‚

è¯¥ä»£ç æ®µä¸­t1æ‹¿åˆ°r1ï¼Œt2æ‹¿åˆ°r2ï¼Œä½†åŒå‘ä¸‹ä¸€æ­¥éœ€è¦å–å¾—çš„é”è¢«å¯¹æ–¹æŒæœ‰ä»è€Œæ— æ³•è¿›è¡Œä¸‹å»ï¼Œç”±æ­¤äº§ç”Ÿäº†æ­»é”ã€‚
è‹¥ä¸¤ä¸ªè¿›ç¨‹éƒ½å…ˆæ‹¿r1ï¼Œå†æ‹¿r2åˆ™å¯ä»¥é¿å…æ­»é”



### å®ˆæŠ¤ï¼ˆåå°ï¼‰çº¿ç¨‹

- æ™®é€šçº¿ç¨‹çš„ç»“æŸï¼Œæ˜¯runæ–¹æ³•è¿è¡Œç»“æŸ
- å®ˆæŠ¤çº¿ç¨‹çš„ç»“æŸï¼Œæ˜¯runæ–¹æ³•è¿è¡Œç»“æŸï¼Œæˆ–mainå‡½æ•°ç»“æŸ
- å®ˆæŠ¤çº¿ç¨‹æ°¸è¿œä¸è¦è®¿é—®èµ„æºï¼Œå¦‚æ–‡ä»¶æˆ–æ•°æ®åº“ç­‰

**ç¤ºä¾‹ä»£ç **

```java
package daemon;

public class ThreadDemo4
{
	public static void main(String args[]) throws InterruptedException
	{
		TestThread4 t = new TestThread4();
		t.setDaemon(true);
		t.start();
		Thread.sleep(2000);
		System.out.println("main thread is exiting");
	}
}
 class TestThread4 extends Thread
{
	public void run() 
	{
		while(true)
		{
			System.out.println("TestThread4" + 
			"ã€€is running");
			try {
				Thread.sleep(1000);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721151011543.png" alt="image-20210721151011543" style="zoom:67%;" />











## Javaå¹¶å‘æ¡†æ¶Executor

### å¹¶è¡Œè®¡ç®—

- å¹¶è¡Œæ¨¡å¼

  - ä¸»ä»æ¨¡å¼ (Master-Slave)
  - Workeræ¨¡å¼(Worker-Worker)

- Javaå¹¶å‘ç¼–ç¨‹

  - Thread/Runnable/Threadç»„ç®¡ç†
  - Executor
  - Fork-Joinæ¡†æ¶

  

### çº¿ç¨‹ç»„ç®¡ç†

çº¿ç¨‹ç»„ T h r e a d G r o u p ThreadGroupThreadGroup

- çº¿ç¨‹çš„é›†åˆ
- æ ‘å½¢ç»“æ„ï¼Œå¤§çº¿ç¨‹ç»„å¯ä»¥åŒ…æ‹¬å°çº¿ç¨‹ç»„
- å¯ä»¥é€šè¿‡enumerateæ–¹æ³•éå†ç»„å†…çš„çº¿ç¨‹ï¼Œæ‰§è¡Œæ“ä½œ
- èƒ½å¤Ÿæœ‰æ•ˆç®¡ç†å¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ç®¡ç†æ•ˆç‡ä½
- ä»»åŠ¡åˆ†é…å’Œæ‰§è¡Œè¿‡ç¨‹é«˜åº¦è€¦åˆ
- é‡å¤åˆ›å»ºçº¿ç¨‹ã€å…³é—­çº¿ç¨‹æ“ä½œï¼Œæ— æ³•é‡ç”¨çº¿ç¨‹



**ç¤ºä¾‹ä»£ç **

```java
package threadgroup;

import java.util.concurrent.TimeUnit;

public class Main {

	public static void main(String[] args) {
	
		// åˆ›å»ºçº¿ç¨‹ç»„
		ThreadGroup threadGroup = new ThreadGroup("Searcher");
		Result result=new Result();
	
		// åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œ10ä¸ªçº¿ç¨‹å®Œæˆ
		Searcher searchTask=new Searcher(result);
		for (int i=0; i<10; i++) {
			Thread thread=new Thread(threadGroup, searchTask);
			thread.start();
			try {
				TimeUnit.SECONDS.sleep(1);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
		System.out.println("========åä¸½ä¸½0=======");
		
		// æŸ¥çœ‹çº¿ç¨‹ç»„æ¶ˆæ¯
		System.out.printf("active çº¿ç¨‹æ•°é‡: %d\n",threadGroup.activeCount());
		System.out.printf("çº¿ç¨‹ç»„ä¿¡æ¯æ˜ç»†\n");
		threadGroup.list();
		System.out.println("========åä¸½ä¸½1=======");
	
		// éå†çº¿ç¨‹ç»„
		Thread[] threads=new Thread[threadGroup.activeCount()];
		threadGroup.enumerate(threads);
		for (int i=0; i<threadGroup.activeCount(); i++) {
			System.out.printf("Thread %s: %s\n",threads[i].getName(),threads[i].getState());
		}
		System.out.println("========åä¸½ä¸½2=======");
	
		// Wait for the finalization of the Threadds
		waitFinish(threadGroup);
		
		// Interrupt all the Thread objects assigned to the ThreadGroup
		threadGroup.interrupt();
	}
	
	public static void waitFinish(ThreadGroup threadGroup) {
		while (threadGroup.activeCount()>9) {
			try {
				TimeUnit.SECONDS.sleep(1);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
	}

}

package threadgroup;

/**

 * æœç´¢ç»“æœç±»
   *
    */
   public class Result {

   private String name;	
   public String getName() {
   	return name;
   }	
   public void setName(String name) {
   	this.name = name;
   }

}
```

```java
package threadgroup;

import java.util.Date;
import java.util.Random;
import java.util.concurrent.TimeUnit;

public class Searcher implements Runnable {

	private Result result;
	
	public Searcher(Result result) {
		this.result=result;
	}
	
	@Override
	public void run() {
		String name=Thread.currentThread().getName();
		System.out.printf("Thread %s: å¯åŠ¨\n",name);
		try {
			doTask();
			result.setName(name);
		} catch (InterruptedException e) {
			System.out.printf("Thread %s: è¢«ä¸­æ–­\n",name);
			return;
		}
		System.out.printf("Thread %s: å®Œæˆ\n",name);
	}
	
	private void doTask() throws InterruptedException {
		Random random=new Random((new Date()).getTime());
		int value=(int)(random.nextDouble()*100);
		System.out.printf("Thread %s: %d\n",Thread.currentThread().getName(),value);
		TimeUnit.SECONDS.sleep(value);
	}

}
```

> activeCountï¼Œè¿”å›çº¿ç¨‹ç»„ä¸­è¿˜å¤„äºactiveçš„çº¿ç¨‹æ•°
> enumerateï¼Œå°†çº¿ç¨‹ç»„ä¸­activeçš„çº¿ç¨‹æ‹·è´åˆ°æ•°ç»„ä¸­
> interruptï¼Œå¯¹çº¿ç¨‹ç»„ä¸­æ‰€æœ‰çš„çº¿ç¨‹å‘å‡ºinterruptä¿¡å·
> listï¼Œæ‰“å°çº¿ç¨‹ç»„ä¸­æ‰€æœ‰çš„çº¿ç¨‹ä¿¡æ¯

è¿è¡Œç»“æœå¦‚ä¸‹

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721151850388.png" alt="image-20210721151850388" style="zoom:67%;" />

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721151909597.png" alt="image-20210721151909597" style="zoom:67%;" />



### å¹¶å‘æ¡†æ¶Executor

- ä»JDK 5å¼€å§‹æä¾›Executor FrameWork (java.util.concurrent.*)
  - åˆ†ç¦»ä»»åŠ¡çš„åˆ›å»ºå’Œæ‰§è¡Œè€…çš„åˆ›å»º
  - çº¿ç¨‹é‡å¤åˆ©ç”¨(newçº¿ç¨‹ä»£ä»·å¾ˆå¤§)
- ç†è§£å…±äº«çº¿ç¨‹æ± çš„æ¦‚å¿µ
  - é¢„è®¾å¥½çš„å¤šä¸ªThreadï¼Œå¯å¼¹æ€§å¢åŠ 
  - å¤šæ¬¡æ‰§è¡Œå¾ˆå¤šå¾ˆå°çš„ä»»åŠ¡
  - ä»»åŠ¡åˆ›å»ºå’Œæ‰§è¡Œè¿‡ç¨‹è§£è€¦
  - ç¨‹åºå‘˜æ— éœ€å…³å¿ƒçº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹
- ä¸»è¦ç±»
  - Executors.newCachedThreadPool/newFixedThreadPool åˆ›å»ºçº¿ç¨‹æ± 
  - ExecutorService çº¿ç¨‹æ± æœåŠ¡
  - Callable å…·ä½“çš„é€»è¾‘å¯¹è±¡(çº¿ç¨‹ç±»)
  - Future è¿”å›ç»“æœ

> Callableå’ŒRunnableæ˜¯ç­‰ä»·çš„ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚
> Runnabçš„runæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œè€ŒCallableçš„callæ–¹æ³•å¯ä»¥æœ‰è¿”å›å€¼ã€‚

**ç¤ºä¾‹ä»£ç 1**

```java
package executor.example1;

public class Main {

	public static void main(String[] args) throws InterruptedException {
		// åˆ›å»ºä¸€ä¸ªæ‰§è¡ŒæœåŠ¡å™¨
		Server server=new Server();
		
		// åˆ›å»º100ä¸ªä»»åŠ¡ï¼Œå¹¶å‘ç»™æ‰§è¡Œå™¨ï¼Œç­‰å¾…å®Œæˆ
		for (int i=0; i<100; i++){
			Task task=new Task("Task "+i);
			Thread.sleep(10);
			server.submitTask(task);
		}		
		server.endServer();
	}

}

package executor.example1;

import java.util.concurrent.Executors;
import java.util.concurrent.ThreadPoolExecutor;
```

```java
/**

 * æ‰§è¡ŒæœåŠ¡å™¨
   *
    */
   public class Server {

   //çº¿ç¨‹æ± 
   private ThreadPoolExecutor executor;

   public Server(){
   	executor=(ThreadPoolExecutor)Executors.newCachedThreadPool(); //å¼¹æ€§å®¹é‡
   	//executor=(ThreadPoolExecutor)Executors.newFixedThreadPool(5);
   }

   //å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡
   public void submitTask(Task task){
   	System.out.printf("Server: A new task has arrived\n");
   	executor.execute(task); //æ‰§è¡Œ  æ— è¿”å›å€¼
   	

   	System.out.printf("Server: Pool Size: %d\n",executor.getPoolSize());
   	System.out.printf("Server: Active Count: %d\n",executor.getActiveCount());
   	System.out.printf("Server: Completed Tasks: %d\n",executor.getCompletedTaskCount());

   }

   public void endServer() {
   	executor.shutdown();
   }
   }
   
   package executor.example1;
```

```java
import java.util.Date;
import java.util.concurrent.TimeUnit;
/**

 * Task ä»»åŠ¡ç±»

 * @author Tom
   *
    */
   public class Task implements Runnable {

   private String name;

   public Task(String name){
   	this.name=name;
   }

   public void run() {
   	try {
   		Long duration=(long)(Math.random()*1000);
   		System.out.printf("%s: Task %s: Doing a task during %d seconds\n",Thread.currentThread().getName(),name,duration);
   		Thread.sleep(duration);			
   	} catch (InterruptedException e) {
   		e.printStackTrace();
   	}
   	

   	System.out.printf("%s: Task %s: Finished on: %s\n",Thread.currentThread().getName(),name,new Date());

   }
   }
   
```


éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721152200533.png" alt="image-20210721152200533" style="zoom:67%;" />

**ç¤ºä¾‹ä»£ç 2**

```java
package executor.example2;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.ThreadPoolExecutor;


public class SumTest {

	public static void main(String[] args) {
		
		// æ‰§è¡Œçº¿ç¨‹æ± 
		ThreadPoolExecutor executor=(ThreadPoolExecutor)Executors.newFixedThreadPool(4);
		
		List<Future<Integer>> resultList=new ArrayList<>();
	
		//ç»Ÿè®¡1-1000æ€»å’Œï¼Œåˆ†æˆ10ä¸ªä»»åŠ¡è®¡ç®—ï¼Œæäº¤ä»»åŠ¡
		for (int i=0; i<10; i++){
			SumTask calculator=new SumTask(i*100+1, (i+1)*100);
			Future<Integer> result=executor.submit(calculator);
			resultList.add(result);
		}
		
		// æ¯éš”50æ¯«ç§’ï¼Œè½®è¯¢ç­‰å¾…10ä¸ªä»»åŠ¡ç»“æŸ
		do {
			System.out.printf("Main: å·²ç»å®Œæˆå¤šå°‘ä¸ªä»»åŠ¡: %d\n",executor.getCompletedTaskCount());
			for (int i=0; i<resultList.size(); i++) {
				Future<Integer> result=resultList.get(i);
				System.out.printf("Main: Task %d: %s\n",i,result.isDone());
			}
			try {
				Thread.sleep(50);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		} while (executor.getCompletedTaskCount()<resultList.size());
		
		// æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»ç»“æŸäº†ï¼Œç»¼åˆè®¡ç®—ç»“æœ		
		int total = 0;
		for (int i=0; i<resultList.size(); i++) {
			Future<Integer> result=resultList.get(i);
			Integer sum=null;
			try {
				sum=result.get();
				total = total + sum;
			} catch (InterruptedException e) {
				e.printStackTrace();
			} catch (ExecutionException e) {
				e.printStackTrace();
			}
		}
		System.out.printf("1-1000çš„æ€»å’Œ:" + total);
		
		// å…³é—­çº¿ç¨‹æ± 
		executor.shutdown();
	}

}
```

```java
package executor.example2;

import java.util.Random;
import java.util.concurrent.Callable;

public class SumTask implements Callable<Integer> {
	//å®šä¹‰æ¯ä¸ªçº¿ç¨‹è®¡ç®—çš„åŒºé—´
	private int startNumber;
	private int endNumber;
	

	public SumTask(int startNumber, int endNumber){
		this.startNumber=startNumber;
		this.endNumber=endNumber;
	}
	
	@Override
	public Integer call() throws Exception {
		int sum = 0;
		for(int i=startNumber; i<=endNumber; i++)
		{
			sum = sum + i;
		}
		
		Thread.sleep(new Random().nextInt(1000));
		
		System.out.printf("%s: %d\n",Thread.currentThread().getName(),sum);
		return sum;
	}

}

```

éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721152318672.png" alt="image-20210721152318672" style="zoom:80%;" />



## Javaå¹¶å‘æ¡†æ¶Fork-Join

- Java 7 æä¾›å¦ä¸€ç§å¹¶è¡Œæ¡†æ¶ï¼šåˆ†è§£ã€æ²»ç†ã€åˆå¹¶(åˆ†æ²»ç¼–ç¨‹)
- é€‚åˆç”¨äºæ•´ä½“ä»»åŠ¡é‡ä¸å¥½ç¡®å®šçš„åœºåˆ(æœ€å°ä»»åŠ¡å¯ç¡®å®š)

### å…³é”®ç±»

ForkJoinPool ä»»åŠ¡æ± 
RecursiveAction
RecursiveTask

**ç¤ºä¾‹ä»£ç **

```java
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ForkJoinPool;
import java.util.concurrent.ForkJoinTask;

//åˆ†ä»»åŠ¡æ±‚å’Œ
public class SumTest {
    

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        //åˆ›å»ºæ‰§è¡Œçº¿ç¨‹æ± 
    	ForkJoinPool pool = new ForkJoinPool();
    	//ForkJoinPool pool = new ForkJoinPool(4);
    	
    	//åˆ›å»ºä»»åŠ¡
        SumTask task = new SumTask(1, 10000000);
        
        //æäº¤ä»»åŠ¡
        ForkJoinTask<Long> result = pool.submit(task);
        
        //ç­‰å¾…ç»“æœ
        do {
    		System.out.printf("Main: Thread Count: %d\n",pool.getActiveThreadCount());
    		System.out.printf("Main: Paralelism: %d\n",pool.getParallelism());
    		try {
    			Thread.sleep(50);
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    	} while (!task.isDone());
        
        //è¾“å‡ºç»“æœ
        System.out.println(result.get().toString());
    }

}
```

```java
import java.math.BigInteger;
import java.util.concurrent.RecursiveTask;

//åˆ†ä»»åŠ¡æ±‚å’Œ
public class SumTask extends RecursiveTask<Long> {
	

	private int start;
	private int end;
	
	public SumTask(int start, int end) {
		this.start = start;
		this.end = end;
	}
	
	public static final int threadhold = 5;
	
	@Override
	protected Long compute() {
		Long sum = 0L;
		
		// å¦‚æœä»»åŠ¡è¶³å¤Ÿå°, å°±ç›´æ¥æ‰§è¡Œ
		boolean canCompute = (end - start) <= threadhold;
		if (canCompute) {
			for (int i = start; i <= end; i++) {
				sum = sum + i;				
			}
		} else {
			// ä»»åŠ¡å¤§äºé˜ˆå€¼, åˆ†è£‚ä¸º2ä¸ªä»»åŠ¡
			int middle = (start + end) / 2;
			SumTask subTask1 = new SumTask(start, middle);
			SumTask subTask2 = new SumTask(middle + 1, end);
	
			invokeAll(subTask1, subTask2);
	
			Long sum1 = subTask1.join();
			Long sum2 = subTask2.join();
	
			// ç»“æœåˆå¹¶
			sum = sum1 + sum2;
		}
		return sum;
	}

}

```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721152419131.png" alt="image-20210721152419131" style="zoom:80%;" />



## Javaå¹¶å‘æ•°æ®ç»“æ„

- å¸¸ç”¨çš„æ•°æ®ç»“æ„æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„
  - ArrayList, HashMap, HashSet éåŒæ­¥çš„
  - å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™ï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸æˆ–æ•°æ®é”™è¯¯
- ä¼ ç»ŸVectorï¼ŒHashtableç­‰åŒæ­¥é›†åˆæ€§èƒ½è¿‡å·®
- å¹¶å‘æ•°æ®ç»“æ„ï¼šæ•°æ®æ·»åŠ å’Œåˆ é™¤
  - é˜»å¡å¼é›†åˆï¼šå½“é›†åˆä¸ºç©ºæˆ–è€…æ»¡æ—¶ï¼Œç­‰å¾…
  - éé˜»å¡å¼é›†åˆï¼šå½“é›†åˆä¸ºç©ºæˆ–è€…æ»¡æ—¶ï¼Œä¸ç­‰å¾…ï¼Œè¿”å›nullæˆ–å¼‚å¸¸



### List

- Vector åŒæ­¥å®‰å…¨ï¼Œå†™å¤šè¯»å°‘
- ArrayList ä¸å®‰å…¨
- Collections.synchronizedList(List list) åŸºäºsynchronizedï¼Œæ•ˆç‡å·®

> synchronizedæ‰€åŒ…å›´çš„ä»£ç ä¸€æ¬¡åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œ

- CopyOnWriteArrayList è¯»å¤šå†™å°‘ï¼ŒåŸºäºå¤åˆ¶æœºåˆ¶ï¼Œéé˜»å¡



**ç¤ºä¾‹ä»£ç **

```java
package list;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.CopyOnWriteArrayList;

public class ListTest {    

    public static void main(String[] args) throws InterruptedException{
    
        //çº¿ç¨‹ä¸å®‰å…¨
        List<String> unsafeList = new ArrayList<String>();
        //çº¿ç¨‹å®‰å…¨
        List<String> safeList1 = Collections.synchronizedList(new ArrayList<String>());
        //çº¿ç¨‹å®‰å…¨
        CopyOnWriteArrayList<String> safeList2 = new CopyOnWriteArrayList<String>();
    
        ListThread t1 = new ListThread(unsafeList);
        ListThread t2 = new ListThread(safeList1);
        ListThread t3 = new ListThread(safeList2);
    
        for(int i = 0; i < 10; i++){
            Thread t = new Thread(t1, String.valueOf(i));
            t.start();
        }
        for(int i = 0; i < 10; i++) {
            Thread t = new Thread(t2, String.valueOf(i));
            t.start();
        }
        for(int i = 0; i < 10; i++) {
            Thread t = new Thread(t3, String.valueOf(i));
            t.start();
        }
    
        //ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œ
        Thread.sleep(2000);
     
        System.out.println("listThread1.list.size() = " + t1.list.size());
        System.out.println("listThread2.list.size() = " + t2.list.size());
        System.out.println("listThread3.list.size() = " + t3.list.size());
    
        //è¾“å‡ºlistä¸­çš„å€¼
        System.out.println("unsafeListï¼š");
        for(String s : t1.list){
            if(s == null){
            	System.out.print("null  ");
            }
            else
            {
            	System.out.print(s + "  ");
            }
        }
        System.out.println();
        System.out.println("safeList1ï¼š");
        for(String s : t2.list){
        	if(s == null){
            	System.out.print("null  ");
            }
            else
            {
            	System.out.print(s + "  ");
            }
        }
        System.out.println();
        System.out.println("safeList2ï¼š");
        for(String s : t3.list){
        	if(s == null){
            	System.out.print("null  ");
            }
            else
            {
            	System.out.print(s + "  ");
            }
        }
    }

}

class ListThread implements Runnable{
	public List<String> list;

    public ListThread(List<String> list){
        this.list = list;
    }
    
    @Override
    public void run() {
    	int i = 0;
    	while(i<10)
    	{
    		try {
                Thread.sleep(10);
            }catch (InterruptedException e){
                e.printStackTrace();
            }
            //æŠŠå½“å‰çº¿ç¨‹åç§°åŠ å…¥listä¸­
            list.add(Thread.currentThread().getName());
            i++;
    	}        
    }

}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-20210721152653028](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721152653028.png)



### Set

- HashSet ä¸å®‰å…¨
- Collections.synchronizedSet(Set set) åŸºäºsynchronizedï¼Œæ•ˆç‡å·®
- CopyOnWriteArraySet (åŸºäºCopyOnWriteArrayListå®ç°) è¯»å¤šå†™å°‘ï¼Œéé˜»å¡

**ç¤ºä¾‹ä»£ç **

```java
package set;

import java.util.*;
import java.util.concurrent.CopyOnWriteArraySet;

public class SetTest{  

    public static void main(String[] args) throws InterruptedException{
    
        //çº¿ç¨‹ä¸å®‰å…¨
        Set<String> unsafeSet = new HashSet<String>();
        //çº¿ç¨‹å®‰å…¨
        Set<String> safeSet1 = Collections.synchronizedSet(new HashSet<String>());
        //çº¿ç¨‹å®‰å…¨
        CopyOnWriteArraySet<String> safeSet2 = new CopyOnWriteArraySet<String>();
    
        SetThread t1 = new SetThread(unsafeSet);
        SetThread t2 = new SetThread(safeSet1);
        SetThread t3 = new SetThread(safeSet2);
    
        //unsafeSetçš„è¿è¡Œæµ‹è¯•
        for(int i = 0; i < 10; i++){
        	Thread t = new Thread(t1, String.valueOf(i));
        	t.start();
        }
        for(int i = 0; i < 10; i++) {
        	Thread t = new Thread(t2, String.valueOf(i));
            t.start();
        }
        for(int i = 0; i < 10; i++) {
        	Thread t = new Thread(t3, String.valueOf(i));
            t.start();
        }
    
        //ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œ
        Thread.sleep(2000);
     
        System.out.println("setThread1.set.size() = " + t1.set.size());
        System.out.println("setThread2.set.size() = " + t2.set.size());
        System.out.println("setThread3.set.size() = " + t3.set.size());
    
        //è¾“å‡ºsetä¸­çš„å€¼
        System.out.println("unsafeSetï¼š");
        for(String element:t1.set){
            if(element == null){
            	System.out.print("null  ");
            }
            else
            {
            	System.out.print(element + "  ");
            }
        }
        System.out.println();
        System.out.println("safeSet1ï¼š");
        for(String element:t2.set){
        	if(element == null){
            	System.out.print("null  ");
            }
            else
            {
            	System.out.print(element + "  ");
            }
        }
        System.out.println();
        System.out.println("safeSet2ï¼š");
        for(String element:t3.set){
        	if(element == null){
            	System.out.print("null  ");
            }
            else
            {
            	System.out.print(element + "  ");
            }
        }
    }

}

class SetThread implements Runnable{
	public Set<String> set;

    public SetThread(Set<String> set){
        this.set = set;
    }
    
    @Override
    public void run() {
    	int i = 0;
    	while(i<10)
    	{
    		i++;
    		try {
                Thread.sleep(10);
            }catch (InterruptedException e){
                e.printStackTrace();
            }
            //æŠŠå½“å‰çº¿ç¨‹åç§°åŠ å…¥listä¸­
            set.add(Thread.currentThread().getName() + i);
    	}        
    }

}
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

![image-20210721152755640](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721152755640.png)



### Map

- Hashtable åŒæ­¥å®‰å…¨ï¼Œå†™å¤šè¯»å°‘
- HashMap ä¸å®‰å…¨
- Collections.synchronizedMap(Map map) åŸºäºsynchronizedï¼Œæ•ˆç‡å·®
- ConcurrentHashMap è¯»å¤šå†™å°‘ï¼Œéé˜»å¡



**ç¤ºä¾‹ä»£ç **

```java
package map;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class MapTest{    

    public static void main(String[] args) throws InterruptedException{
    
        //çº¿ç¨‹ä¸å®‰å…¨
        Map<Integer,String> unsafeMap = new HashMap<Integer,String>();
        //çº¿ç¨‹å®‰å…¨
        Map<Integer,String> safeMap1 = Collections.synchronizedMap(new HashMap<Integer,String>());
        //çº¿ç¨‹å®‰å…¨
        ConcurrentHashMap<Integer,String> safeMap2 = new ConcurrentHashMap<Integer,String>();
    
        MapThread t1 = new MapThread(unsafeMap);
        MapThread t2 = new MapThread(safeMap1);
        MapThread t3 = new MapThread(safeMap2);
    
        //unsafeMapçš„è¿è¡Œæµ‹è¯•
        for(int i = 0; i < 10; i++){
        	Thread t = new Thread(t1);
        	t.start();
        }       
        for(int i = 0; i < 10; i++) {
        	Thread t = new Thread(t2);
            t.start();
        }
        for(int i = 0; i < 10; i++) {
        	Thread t = new Thread(t3);
            t.start();
        }
    
        //ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œ
        Thread.sleep(2000);
     
        System.out.println("mapThread1.map.size() = " + t1.map.size());
        System.out.println("mapThread2.map.size() = " + t2.map.size());
        System.out.println("mapThread3.map.size() = " + t3.map.size());
    
        //è¾“å‡ºsetä¸­çš„å€¼
        System.out.println("unsafeMapï¼š");
        Iterator iter = t1.map.entrySet().iterator();
        while(iter.hasNext()) {
            Map.Entry<Integer,String> entry = (Map.Entry<Integer,String>)iter.next();
            // è·å–key
            System.out.print(entry.getKey() + ":");
            // è·å–value
            System.out.print(entry.getValue() + " ");
        }
        System.out.println();
        
        System.out.println("safeMap1ï¼š");
        iter = t2.map.entrySet().iterator();
        while(iter.hasNext()) {
            Map.Entry<Integer,String> entry = (Map.Entry<Integer,String>)iter.next();
            // è·å–key
            System.out.print(entry.getKey() + ":");
            // è·å–value
            System.out.print(entry.getValue() + " ");
        }
    
        System.out.println();
        System.out.println("safeMap2ï¼š");
        iter = t3.map.entrySet().iterator();
        while(iter.hasNext()) {
            Map.Entry<Integer,String> entry = (Map.Entry<Integer,String>)iter.next();
            // è·å–key
            System.out.print(entry.getKey() + ":");
            // è·å–value
            System.out.print(entry.getValue() + " ");
        }
        System.out.println();
        System.out.println("mapThread1.map.size() = " + t1.map.size());
        System.out.println("mapThread2.map.size() = " + t2.map.size());
        System.out.println("mapThread3.map.size() = " + t3.map.size());
    }

}

class MapThread implements Runnable
{
	public Map<Integer,String> map;

    public MapThread(Map<Integer,String> map){
        this.map = map;
    }
    
    @Override
    public void run() {
        int i=0;
        
        while(i<100)
        {
        	//æŠŠå½“å‰çº¿ç¨‹åç§°åŠ å…¥mapä¸­
            map.put(i++,Thread.currentThread().getName());
            try {
                Thread.sleep(10);
            }catch (InterruptedException e){
                e.printStackTrace();
            }
        }        
    }

}

```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-20210721152851842](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721152851842.png)

### Queue & Deque

- ConcurrentLinkedQueue éé˜»å¡
- ArrayBlockingQueue/LinkedBlockingQueue é˜»å¡



**ç¤ºä¾‹ä»£ç **

```java
package queue;

import java.util.*;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ConcurrentLinkedDeque;

public class QueueTest {

    public static void main(String[] args) throws InterruptedException{
    
        //çº¿ç¨‹ä¸å®‰å…¨
        Deque<String> unsafeQueue = new ArrayDeque<String>();
        //çº¿ç¨‹å®‰å…¨
        ConcurrentLinkedDeque<String> safeQueue1 = new ConcurrentLinkedDeque<String>();
    
        ArrayBlockingQueue<String> safeQueue2 = new ArrayBlockingQueue<String>(100);
    
        QueueThread t1 = new QueueThread(unsafeQueue);
        QueueThread t2 = new QueueThread(safeQueue1);
        QueueThread t3 = new QueueThread(safeQueue2);
    
        for(int i = 0; i < 10; i++){
            Thread thread1 = new Thread(t1, String.valueOf(i));
            thread1.start();
        }
        for(int i = 0; i < 10; i++) {
            Thread thread2 = new Thread(t2, String.valueOf(i));
            thread2.start();
        }
        for(int i = 0; i < 10; i++) {
            Thread thread3 = new Thread(t3, String.valueOf(i));
            thread3.start();
        }
    
        //ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œ
        Thread.sleep(2000);
     
        System.out.println("queueThread1.queue.size() = " + t1.queue.size());
        System.out.println("queueThread2.queue.size() = " + t2.queue.size());
        System.out.println("queueThread3.queue.size() = " + t3.queue.size());
    
        //è¾“å‡ºqueueä¸­çš„å€¼
        System.out.println("unsafeQueueï¼š");
        for(String s:t1.queue)
        {
        	System.out.print(s + " ");
        }
        System.out.println();
        System.out.println("safeQueue1ï¼š");
        for(String s:t2.queue)
        {
        	System.out.print(s + " ");
        }
        System.out.println();
        System.out.println("safeQueue2ï¼š");
        for(String s:t3.queue)
        {
        	System.out.print(s + " ");
        }
    }

}

class QueueThread implements Runnable{
	public Queue<String> queue;

    public QueueThread(Queue<String> queue){
        this.queue = queue;
    }
    
    @Override
    public void run() {
    	int i = 0;
    	while(i<10)
    	{
    		i++;
    		try {
                Thread.sleep(10);
            }catch (InterruptedException e){
                e.printStackTrace();
            }
            //æŠŠå½“å‰çº¿ç¨‹åç§°åŠ å…¥listä¸­
            queue.add(Thread.currentThread().getName());
    	}        
    }

}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-20210721153002117](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153002117.png)



## Javaå¹¶å‘åä½œæ§åˆ¶

### çº¿ç¨‹åä½œ

- Thread/Executor/Fork-Join
  - çº¿ç¨‹å¯åŠ¨ï¼Œè¿è¡Œï¼Œç»“æŸ
  - çº¿ç¨‹ä¹‹é—´ç¼ºå°‘åä½œ
- synchronized åŒæ­¥
  - é™å®šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½è¿›å…¥å…³é”®åŒº
  - ç®€å•ç²—æš´ï¼Œæ€§èƒ½æŸå¤±æœ‰ç‚¹å¤§ 

### Lock

- Lockä¹Ÿå¯ä»¥å®ç°åŒæ­¥çš„æ•ˆæœ
  - å®ç°æ›´å¤æ‚çš„ä¸´ç•ŒåŒºç»“æ„
  - tryLockæ–¹æ³•å¯ä»¥é¢„åˆ¤é”æ˜¯å¦ç©ºé—²
  - å…è®¸åˆ†ç¦»è¯»å†™çš„æ“ä½œï¼Œå¤šä¸ªè¯»ï¼Œä¸€ä¸ªå†™
  - æ€§èƒ½æ›´å¥½
- ReentrantLockç±»ï¼Œå¯é‡å…¥çš„äº’æ–¥é”
- ReentrantReadWriteLockç±»ï¼Œå¯é‡å…¥çš„è¯»å†™é”
- lockå’Œunlockå‡½æ•°



**ç¤ºä¾‹ä»£ç **

> æœ‰å®¶å¥¶èŒ¶åº—ï¼Œç‚¹å•æœ‰æ—¶éœ€è¦æ’é˜Ÿ
> å‡è®¾æƒ³ä¹°å¥¶èŒ¶çš„äººå¦‚æœçœ‹åˆ°éœ€è¦æ’é˜Ÿï¼Œå°±å†³å®šä¸ä¹°
> åˆå‡è®¾å¥¶èŒ¶åº—æœ‰è€æ¿å’Œå¤šåå‘˜å·¥ï¼Œè®°å•æ–¹å¼æ¯”è¾ƒåŸå§‹ï¼Œåªæœ‰ä¸€ä¸ªè®¢å•æœ¬
> è€æ¿è´Ÿè´£å†™æ–°è®¢å•ï¼Œå‘˜å·¥ä¸æ–­åœ°æŸ¥çœ‹è®¢å•æœ¬å¾—åˆ°ä¿¡æ¯æ¥åˆ¶ä½œå¥¶èŒ¶ï¼Œåœ¨è€æ¿å†™æ–°è®¢å•æ—¶å‘˜å·¥ä¸èƒ½çœ‹è®¢å•æœ¬
> å¤šä¸ªå‘˜å·¥å¯åŒæ—¶çœ‹è®¢å•æœ¬ï¼Œåœ¨å‘˜å·¥çœ‹æ—¶è€æ¿ä¸èƒ½å†™æ–°è®¢å•
>

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;public class LockExample {

	private static final ReentrantLock queueLock = new ReentrantLock(); //å¯é‡å…¥é”
	private static final ReentrantReadWriteLock orderLock = new ReentrantReadWriteLock(); //å¯é‡å…¥è¯»å†™é”
	
	/**
	 * æœ‰å®¶å¥¶èŒ¶åº—ï¼Œç‚¹å•æœ‰æ—¶éœ€è¦æ’é˜Ÿ 
	 * å‡è®¾æƒ³ä¹°å¥¶èŒ¶çš„äººå¦‚æœçœ‹åˆ°éœ€è¦æ’é˜Ÿï¼Œå°±å†³å®šä¸ä¹°
	 * åˆå‡è®¾å¥¶èŒ¶åº—æœ‰è€æ¿å’Œå¤šåå‘˜å·¥ï¼Œè®°å•æ–¹å¼æ¯”è¾ƒåŸå§‹ï¼Œåªæœ‰ä¸€ä¸ªè®¢å•æœ¬
	 * è€æ¿è´Ÿè´£å†™æ–°è®¢å•ï¼Œå‘˜å·¥ä¸æ–­åœ°æŸ¥çœ‹è®¢å•æœ¬å¾—åˆ°ä¿¡æ¯æ¥åˆ¶ä½œå¥¶èŒ¶ï¼Œåœ¨è€æ¿å†™æ–°è®¢å•æ—¶å‘˜å·¥ä¸èƒ½çœ‹è®¢å•æœ¬
	 * å¤šä¸ªå‘˜å·¥å¯åŒæ—¶çœ‹è®¢å•æœ¬ï¼Œåœ¨å‘˜å·¥çœ‹æ—¶è€æ¿ä¸èƒ½å†™æ–°è®¢å•
	 * @param args
	 * @throws InterruptedException 
	 */
	public static void main(String[] args) throws InterruptedException {
		//buyMilkTea();
		handleOrder(); //éœ€æ‰‹åŠ¨å…³é—­
	}
	
	public void tryToBuyMilkTea() throws InterruptedException {
		boolean flag = true;
		while(flag)
		{
			if (queueLock.tryLock()) {
				//queueLock.lock();
				long thinkingTime = (long) (Math.random() * 500);
				Thread.sleep(thinkingTime);
				System.out.println(Thread.currentThread().getName() + "ï¼š æ¥ä¸€æ¯çç å¥¶èŒ¶ï¼Œä¸è¦çç ");
				flag = false;
				queueLock.unlock();
			} else {
				//System.out.println(Thread.currentThread().getName() + "ï¼š" + queueLock.getQueueLength() + "äººåœ¨æ’é˜Ÿ");
				System.out.println(Thread.currentThread().getName() + "ï¼š å†ç­‰ç­‰");
			}
			if(flag)
			{
				Thread.sleep(1000);
			}
		}
		
	}
	
	public void addOrder() throws InterruptedException {
		orderLock.writeLock().lock();
		long writingTime = (long) (Math.random() * 1000);
		Thread.sleep(writingTime);
		System.out.println("è€æ¿æ–°åŠ ä¸€ç¬”è®¢å•");
		orderLock.writeLock().unlock();
	}
	
	public void viewOrder() throws InterruptedException {
		orderLock.readLock().lock();
			
		long readingTime = (long) (Math.random() * 500);
		Thread.sleep(readingTime);
		System.out.println(Thread.currentThread().getName() + ": æŸ¥çœ‹è®¢å•æœ¬");
		orderLock.readLock().unlock();			
	
	}
	
	public static void buyMilkTea() throws InterruptedException {
		LockExample lockExample = new LockExample();
		int STUDENTS_CNT = 10;
		
		Thread[] students = new Thread[STUDENTS_CNT];
		for (int i = 0; i < STUDENTS_CNT; i++) {
			students[i] = new Thread(new Runnable() {
	
				@Override
				public void run() {
					try {
						long walkingTime = (long) (Math.random() * 1000);
						Thread.sleep(walkingTime);
						lockExample.tryToBuyMilkTea();
					} catch(InterruptedException e) {
						System.out.println(e.getMessage());
					}
				}
				
			}
			);
			
			students[i].start();
		}
		
		for (int i = 0; i < STUDENTS_CNT; i++)
			students[i].join();
	
	}


â€‹	

	public static void handleOrder() throws InterruptedException {
		LockExample lockExample = new LockExample();


â€‹		

		Thread boss = new Thread(new Runnable() {
	
			@Override
			public void run() {
				while (true) {
					try {
						lockExample.addOrder();
						long waitingTime = (long) (Math.random() * 1000);
						Thread.sleep(waitingTime);
					} catch (InterruptedException e) {
						System.out.println(e.getMessage());
					}
				}
			}
		});
		boss.start();
	
		int workerCnt = 3;
		Thread[] workers = new Thread[workerCnt];
		for (int i = 0; i < workerCnt; i++)
		{
			workers[i] = new Thread(new Runnable() {
	
				@Override
				public void run() {
					while (true) {
						try {
								lockExample.viewOrder();
								long workingTime = (long) (Math.random() * 5000);
								Thread.sleep(workingTime);
							} catch (InterruptedException e) {
								System.out.println(e.getMessage());
							}
						}
				}
				
			});
			
			workers[i].start();
		}
		
	}

}
```

> readLockï¼Œè¯»é”
> å¯ä»¥å¤šä¸ªçº¿ç¨‹å…±äº«
> writeLockï¼Œå†™é”
> æ’ä»–çš„ï¼Œåªèƒ½ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

buyMilkTea()

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153226004.png" alt="image-20210721153226004" style="zoom:67%;" />


handleOrder()

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153241472.png" alt="image-20210721153241472" style="zoom:80%;" />



### Semaphore

- ä¿¡å·é‡ï¼Œç”±1965å¹´Dijkstraæå‡ºçš„
- ä¿¡å·é‡ï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè®¡æ•°å™¨
- è®¡æ•°å™¨å¤§äº0ï¼Œå¯ä»¥ä½¿ç”¨ï¼Œç­‰äº0ä¸èƒ½ä½¿ç”¨
- å¯ä»¥è®¾ç½®å¤šä¸ªå¹¶å‘é‡ï¼Œä¾‹å¦‚é™åˆ¶10ä¸ªè®¿é—®
- Semaphore
  - acquireè·å–
  - releaseé‡Šæ”¾
- æ¯”Lockæ›´è¿›ä¸€æ­¥ï¼Œå¯ä»¥æ§åˆ¶å¤šä¸ªåŒæ—¶è®¿é—®å…³é”®åŒº



**ç¤ºä¾‹ä»£ç **

> ç°æœ‰ä¸€åœ°ä¸‹è½¦åº“ï¼Œå…±æœ‰è½¦ä½5ä¸ªï¼Œç”±10è¾†è½¦éœ€è¦åœæ”¾ï¼Œæ¯æ¬¡åœæ”¾æ—¶ï¼Œå»ç”³è¯·ä¿¡å·é‡

```java
import java.util.concurrent.Semaphore;

public class SemaphoreExample {

	private final Semaphore placeSemaphore = new Semaphore(5);
	
	public boolean parking() throws InterruptedException {
		if (placeSemaphore.tryAcquire()) {
			System.out.println(Thread.currentThread().getName() + ": åœè½¦æˆåŠŸ");
			return true;
		} else {
			System.out.println(Thread.currentThread().getName() + ": æ²¡æœ‰ç©ºä½");
			return false;
		}
	
	}
	
	public void leaving() throws InterruptedException {
		placeSemaphore.release();
		System.out.println(Thread.currentThread().getName() + ": å¼€èµ°");
	}
	
	/**
	 * ç°æœ‰ä¸€åœ°ä¸‹è½¦åº“ï¼Œå…±æœ‰è½¦ä½5ä¸ªï¼Œç”±10è¾†è½¦éœ€è¦åœæ”¾ï¼Œæ¯æ¬¡åœæ”¾æ—¶ï¼Œå»ç”³è¯·ä¿¡å·é‡
	 * @param args
	 * @throws InterruptedException 
	 */
	public static void main(String[] args) throws InterruptedException {
		int tryToParkCnt = 10;
		
		SemaphoreExample semaphoreExample = new SemaphoreExample();
		
		Thread[] parkers = new Thread[tryToParkCnt];
		
		for (int i = 0; i < tryToParkCnt; i++) {
			parkers[i] = new Thread(new Runnable() {
	
				@Override
				public void run() {
					try {
						long randomTime = (long) (Math.random() * 1000);
						Thread.sleep(randomTime);
						if (semaphoreExample.parking()) {
							long parkingTime = (long) (Math.random() * 1200);
							Thread.sleep(parkingTime);
							semaphoreExample.leaving();
						}
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			});
			
			parkers[i].start();
		}
	
		for (int i = 0; i < tryToParkCnt; i++) {
			parkers[i].join();
		}	
	}

}

```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153408280.png" alt="image-20210721153408280" style="zoom:80%;" />



### Latch

- ç­‰å¾…é”ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»
- ç”¨æ¥åŒæ­¥æ‰§è¡Œä»»åŠ¡çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹
- ä¸æ˜¯ç”¨æ¥ä¿æŠ¤ä¸´ç•ŒåŒºæˆ–è€…å…±äº«èµ„æº
- CountDownLatch
  - countDown() è®¡æ•°å‡1
  - await() ç­‰å¾…latchå˜æˆ0



> è®¾æƒ³ç™¾ç±³èµ›è·‘æ¯”èµ› å‘ä»¤æªå‘å‡ºä¿¡å·åé€‰æ‰‹å¼€å§‹è·‘ï¼Œå…¨éƒ¨é€‰æ‰‹è·‘åˆ°ç»ˆç‚¹åæ¯”èµ›ç»“æŸ

**ç¤ºä¾‹ä»£ç **

```java
import java.util.concurrent.CountDownLatch;

public class CountDownLatchExample {

	/**
	 * è®¾æƒ³ç™¾ç±³èµ›è·‘æ¯”èµ› å‘ä»¤æªå‘å‡ºä¿¡å·åé€‰æ‰‹å¼€å§‹è·‘ï¼Œå…¨éƒ¨é€‰æ‰‹è·‘åˆ°ç»ˆç‚¹åæ¯”èµ›ç»“æŸ
	 * 
	 * @param args
	 * @throws InterruptedException
	 */
	public static void main(String[] args) throws InterruptedException {
		int runnerCnt = 10;
		CountDownLatch startSignal = new CountDownLatch(1);
		CountDownLatch doneSignal = new CountDownLatch(runnerCnt);
	
		for (int i = 0; i < runnerCnt; ++i) // create and start threads
			new Thread(new Worker(startSignal, doneSignal)).start();
	
		System.out.println("å‡†å¤‡å·¥ä½œ...");
		System.out.println("å‡†å¤‡å·¥ä½œå°±ç»ª");
		startSignal.countDown(); // let all threads proceed
		System.out.println("æ¯”èµ›å¼€å§‹");
		doneSignal.await(); // wait for all to finish
		System.out.println("æ¯”èµ›ç»“æŸ");
	}
	
	static class Worker implements Runnable {
		private final CountDownLatch startSignal;
		private final CountDownLatch doneSignal;
	
		Worker(CountDownLatch startSignal, CountDownLatch doneSignal) {
			this.startSignal = startSignal;
			this.doneSignal = doneSignal;
		}
	
		public void run() {
			try {
				startSignal.await();
				doWork();
				doneSignal.countDown();
			} catch (InterruptedException ex) {
			} // return;
		}
	
		void doWork() {
			System.out.println(Thread.currentThread().getName() + ": è·‘å®Œå…¨ç¨‹");
		}
	}

}
```

> Latchå˜æˆ0ä»¥åå°†å”¤é†’æ‰€æœ‰åœ¨æ­¤Latchä¸Šawaitçš„çº¿ç¨‹ï¼Œè§£é”å®ƒä»¬çš„awaitç­‰å¾…ã€‚

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153523120.png" alt="image-20210721153523120" style="zoom:80%;" />



### Barrier

- é›†åˆç‚¹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»
- å…è®¸å¤šä¸ªçº¿ç¨‹åœ¨æŸä¸€ä¸ªç‚¹ä¸Šè¿›è¡ŒåŒæ­¥
- CyclicBarrier
  - æ„é€ å‡½æ•°æ˜¯éœ€è¦åŒæ­¥çš„çº¿ç¨‹æ•°é‡
  - awaitç­‰å¾…å…¶ä»–çº¿ç¨‹ï¼Œåˆ°è¾¾æ•°é‡åï¼Œå°±æ”¾è¡Œ

**ç¤ºä¾‹ä»£ç **

> å‡å®šæœ‰ä¸‰è¡Œæ•°ï¼Œç”¨ä¸‰ä¸ªçº¿ç¨‹åˆ†åˆ«è®¡ç®—æ¯ä¸€è¡Œçš„å’Œï¼Œæœ€ç»ˆè®¡ç®—æ€»å’Œ

```java
import java.util.concurrent.BrokenBarrierException;
import java.util.concurrent.CyclicBarrier;

public class CyclicBarrierExample {
	

	/**
	 * å‡å®šæœ‰ä¸‰è¡Œæ•°ï¼Œç”¨ä¸‰ä¸ªçº¿ç¨‹åˆ†åˆ«è®¡ç®—æ¯ä¸€è¡Œçš„å’Œï¼Œæœ€ç»ˆè®¡ç®—æ€»å’Œ
	 * @param args
	 */
	public static void main(String[] args) {
		final int[][] numbers = new int[3][5];
		final int[] results = new int[3];
		int[] row1 = new int[]{1, 2, 3, 4, 5};
		int[] row2 = new int[]{6, 7, 8, 9, 10};
		int[] row3 = new int[]{11, 12, 13, 14, 15};
		numbers[0] = row1;
		numbers[1] = row2;
		numbers[2] = row3;
		
		CalculateFinalResult finalResultCalculator = new CalculateFinalResult(results);
		CyclicBarrier barrier = new CyclicBarrier(3, finalResultCalculator);
		//å½“æœ‰3ä¸ªçº¿ç¨‹åœ¨barrierä¸Šawaitï¼Œå°±æ‰§è¡ŒfinalResultCalculator
		
		for(int i = 0; i < 3; i++) {
			CalculateEachRow rowCalculator = new CalculateEachRow(barrier, numbers, i, results);
			new Thread(rowCalculator).start();
		}		
	}

}

class CalculateEachRow implements Runnable {

	final int[][] numbers;
	final int rowNumber;
	final int[] res;
	final CyclicBarrier barrier;
	
	CalculateEachRow(CyclicBarrier barrier, int[][] numbers, int rowNumber, int[] res) {
		this.barrier = barrier;
		this.numbers = numbers;
		this.rowNumber = rowNumber;
		this.res = res;
	}
	
	@Override
	public void run() {
		int[] row = numbers[rowNumber];
		int sum = 0;
		for (int data : row) {
			sum += data;
			res[rowNumber] = sum;
		}
		try {
			System.out.println(Thread.currentThread().getName() + ": è®¡ç®—ç¬¬" + (rowNumber + 1) + "è¡Œç»“æŸï¼Œç»“æœä¸º: " + sum);
			barrier.await(); //ç­‰å¾…ï¼åªè¦è¶…è¿‡3ä¸ª(Barrierçš„æ„é€ å‚æ•°)ï¼Œå°±æ”¾è¡Œã€‚
		} catch (InterruptedException | BrokenBarrierException e) {
			e.printStackTrace();
		}
	}

}


class CalculateFinalResult implements Runnable {
	final int[] eachRowRes;
	int finalRes;
	public int getFinalResult() {
		return finalRes;
	}
	

	CalculateFinalResult(int[] eachRowRes) {
		this.eachRowRes = eachRowRes;
	}
	
	@Override
	public void run() {
		int sum = 0;
		for(int data : eachRowRes) {
			sum += data;
		}
		finalRes = sum;
		System.out.println("æœ€ç»ˆç»“æœä¸º: " + finalRes);
	}

}

```

> å½“åœ¨Barrierä¸Šawaitçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°é¢„å®šçš„è¦æ±‚åï¼Œæ‰€æœ‰çš„awaitçš„çº¿ç¨‹ä¸å†ç­‰å¾…ï¼Œå…¨éƒ¨è§£é”ã€‚
> è€Œä¸”Barrierå°†æ‰§è¡Œé¢„å®šçš„å›è°ƒåŠ¨ä½œï¼ˆåœ¨æœ¬ç¨‹åºä¸­ï¼Œå›è°ƒåŠ¨ä½œå°±æ˜¯CalculateFinalResultï¼‰ã€‚

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153630429.png" alt="image-20210721153630429" style="zoom:80%;" />



### Phaser

- å…è®¸æ‰§è¡Œå¹¶å‘å¤šé˜¶æ®µä»»åŠ¡ï¼ŒåŒæ­¥è¾…åŠ©ç±»
- åœ¨æ¯ä¸€ä¸ªé˜¶æ®µç»“æŸçš„ä½ç½®å¯¹çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œå½“æ‰€æœ‰çš„çº¿ç¨‹éƒ½åˆ°è¾¾è¿™æ­¥ï¼Œå†è¿›è¡Œä¸‹ä¸€æ­¥
- Phaser
  - arrive()
  - arriveAndAwaitAdvance()

**ç¤ºä¾‹ä»£ç **

> å‡è®¾ä¸¾è¡Œè€ƒè¯•ï¼Œæ€»å…±ä¸‰é“å¤§é¢˜ï¼Œæ¯æ¬¡ä¸‹å‘ä¸€é“é¢˜ç›®ï¼Œç­‰æ‰€æœ‰å­¦ç”Ÿå®Œæˆåå†è¿›è¡Œä¸‹ä¸€é“

```java
import java.util.concurrent.Phaser;

public class PhaserExample {

	/**
	 * å‡è®¾ä¸¾è¡Œè€ƒè¯•ï¼Œæ€»å…±ä¸‰é“å¤§é¢˜ï¼Œæ¯æ¬¡ä¸‹å‘ä¸€é“é¢˜ç›®ï¼Œç­‰æ‰€æœ‰å­¦ç”Ÿå®Œæˆåå†è¿›è¡Œä¸‹ä¸€é“
	 * 
	 * @param args
	 */
	public static void main(String[] args) {
	
		int studentsCnt = 5;
		Phaser phaser = new Phaser(studentsCnt);
	
		for (int i = 0; i < studentsCnt; i++) {
			new Thread(new Student(phaser)).start();
		}
	}

}

class Student implements Runnable {

	private final Phaser phaser;
	
	public Student(Phaser phaser) {
		this.phaser = phaser;
	}
	
	@Override
	public void run() {
		try {
			doTesting(1);
			phaser.arriveAndAwaitAdvance(); //ç­‰åˆ°5ä¸ªçº¿ç¨‹éƒ½åˆ°äº†ï¼Œæ‰æ”¾è¡Œ
			doTesting(2);
			phaser.arriveAndAwaitAdvance();
			doTesting(3);
			phaser.arriveAndAwaitAdvance();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
	
	private void doTesting(int i) throws InterruptedException {
		String name = Thread.currentThread().getName();
		System.out.println(name + "å¼€å§‹ç­”ç¬¬" + i + "é¢˜");
		long thinkingTime = (long) (Math.random() * 1000);
		Thread.sleep(thinkingTime);
		System.out.println(name + "ç¬¬" + i + "é“é¢˜ç­”é¢˜ç»“æŸ");
	}

}

```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153727014.png" alt="image-20210721153727014" style="zoom:80%;" />

### Exchanger

- å…è®¸åœ¨å¹¶å‘çº¿ç¨‹ä¸­äº’ç›¸äº¤æ¢æ¶ˆæ¯
- å…è®¸åœ¨2ä¸ªçº¿ç¨‹ä¸­å®šä¹‰åŒæ­¥ç‚¹ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹ï¼Œå®ƒä»¬äº¤æ¢æ•°æ®ç»“æ„
- Exchanger
  - exchange(), çº¿ç¨‹åŒæ–¹äº’ç›¸äº¤äº’æ•°æ®
  - äº¤æ¢æ•°æ®æ˜¯åŒå‘çš„

**ç¤ºä¾‹ä»£ç **

> æœ¬ä¾‹é€šè¿‡Exchangerå®ç°å­¦ç”Ÿæˆç»©æŸ¥è¯¢ï¼Œç®€å•çº¿ç¨‹é—´æ•°æ®çš„äº¤æ¢

```java
import java.util.Scanner;
import java.util.concurrent.Exchanger;

public class ExchangerExample {
	

	/**
	 * æœ¬ä¾‹é€šè¿‡Exchangerå®ç°å­¦ç”Ÿæˆç»©æŸ¥è¯¢ï¼Œç®€å•çº¿ç¨‹é—´æ•°æ®çš„äº¤æ¢
	 * @param args
	 * @throws InterruptedException
	 */
	public static void main(String[] args) throws InterruptedException {
		Exchanger<String> exchanger = new Exchanger<String>();
		BackgroundWorker worker = new BackgroundWorker(exchanger);
		new Thread(worker).start();
		
		Scanner scanner = new Scanner(System.in);
		while(true) {
			System.out.println("è¾“å…¥è¦æŸ¥è¯¢çš„å±æ€§å­¦ç”Ÿå§“åï¼š");
			String input = scanner.nextLine().trim();
			exchanger.exchange(input); //æŠŠç”¨æˆ·è¾“å…¥ä¼ é€’ç»™çº¿ç¨‹
			String value = exchanger.exchange(null); //æ‹¿åˆ°çº¿ç¨‹åé¦ˆç»“æœ
			if ("exit".equals(value)) {
				break;
			}
			System.out.println("æŸ¥è¯¢ç»“æœï¼š" + value);
		}
		scanner.close();
	} 

}

class BackgroundWorker implements Runnable {

	final Exchanger<String> exchanger;
	BackgroundWorker(Exchanger<String> exchanger) {
		this.exchanger = exchanger;
	}
	@Override
	public void run() {
		while (true) {
			try {
				String item = exchanger.exchange(null);
				switch (item) {
				case "zhangsan": 
					exchanger.exchange("90");
					break;
				case "lisi":
					exchanger.exchange("80");
					break;
				case "wangwu":
					exchanger.exchange("70");
					break;
				case "exit":
					exchanger.exchange("exit");
					return;
				default:
					exchanger.exchange("æŸ¥æ— æ­¤äºº");
				}					
			} catch (InterruptedException e) {
				e.printStackTrace();
			}				
		}
	}		

}

```

> å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åŒæ—¶æ‰§è¡Œåˆ°åŒä¸€ä¸ªexchangerçš„exchangeæ–¹æ³•ï¼Œä¸¤ä¸ªçº¿ç¨‹å°±ç›¸äº’äº¤æ¢æ•°æ®ï¼Œäº¤æ¢æ˜¯åŒå‘çš„ã€‚

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153827253.png" alt="image-20210721153827253" style="zoom:80%;" />

## Javaå®šæ—¶ä»»åŠ¡æ‰§è¡Œ

### å®šæ—¶ä»»åŠ¡

- Thread/Executor/Fork-Join å¤šçº¿ç¨‹
  - ç«‹åˆ»æ‰§è¡Œ
  - æ¡†æ¶è°ƒåº¦
- å®šæ—¶æ‰§è¡Œ
  - å›ºå®šæŸä¸€ä¸ªæ—¶é—´ç‚¹è¿è¡Œ
  - ä»¥æŸä¸€ä¸ªå‘¨æœŸ

### ç®€å•å®šæ—¶å™¨æœºåˆ¶ï¼ˆTimerï¼‰

- è®¾ç½®è®¡åˆ’ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯åœ¨æŒ‡å®šçš„æ—¶é—´å¼€å§‹æ‰§è¡ŒæŸä¸€ä¸ªä»»åŠ¡ã€‚
- TimerTask å°è£…ä»»åŠ¡
- Timerç±» å®šæ—¶å™¨

**ç¤ºä¾‹ä»£ç **

> TimerTaskä¹Ÿæ˜¯ç»§æ‰¿äºRunnableè¿™ä¸ªæ¥å£
> schedule(TimerTask task, long dâ€˜elay) å»¶è¿Ÿ delay æ¯«ç§’æ‰§è¡Œ
> schedule(TimerTask task, Date time) ç‰¹å®šæ—¶é—´æ‰§è¡Œ
> schedule(TimerTask task, long delay, long period) å»¶è¿Ÿ delay æ‰§è¡Œå¹¶æ¯éš”period æ‰§è¡Œä¸€æ¬¡

```java
package timer;

import java.util.Calendar;
import java.util.Date;
import java.util.Timer;
import java.util.TimerTask;

public class TimerTest {
	public static void main(String[] args) throws InterruptedException {
			MyTask task = new MyTask();
			Timer timer = new Timer();
			

			System.out.println("å½“å‰æ—¶é—´ï¼š"+new Date().toLocaleString());
			//å½“å‰æ—¶é—´1ç§’åï¼Œæ¯2ç§’æ‰§è¡Œä¸€æ¬¡
			timer.schedule(task, 1000, 2000);
			
			Thread.sleep(10000);
			task.cancel();  //å–æ¶ˆå½“å‰çš„ä»»åŠ¡
			
			System.out.println("================================");
			
			Calendar now = Calendar.getInstance();
			now.set(Calendar.SECOND,now.get(Calendar.SECOND)+3);
	        Date runDate = now.getTime();
	        MyTask2 task2 = new MyTask2();
	        timer.scheduleAtFixedRate(task2,runDate,3000); //å›ºå®šé€Ÿç‡


â€‹			

	        Thread.sleep(20000);
			timer.cancel();  //å–æ¶ˆå®šæ—¶å™¨
	}

}

class MyTask extends TimerTask {
	public void run() {
		System.out.println("è¿è¡Œäº†ï¼æ—¶é—´ä¸ºï¼š" + new Date());
	}
}

class MyTask2 extends TimerTask {
	public void run() {
		System.out.println("è¿è¡Œäº†ï¼æ—¶é—´ä¸ºï¼š" + new Date());
		try {
			Thread.sleep(4000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
}
```


è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

 <img src="C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721153959416.png" alt="image-20210721153959416" style="zoom:80%;" />

> ä¸€ä¸ªTimerå¯¹è±¡å¯ä»¥æ‰§è¡Œå¤šä¸ªè®¡åˆ’ä»»åŠ¡ï¼Œä½†æ˜¯è¿™äº›ä»»åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚å¦‚æœæœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå¾ˆæ…¢ï¼Œå°†ä¼šå½±å“åç»­çš„ä»»åŠ¡å‡†ç‚¹è¿è¡Œã€‚



### Executor +å®šæ—¶å™¨æœºåˆ¶

#### ScheduledExecutorService

- å®šæ—¶ä»»åŠ¡
- å‘¨æœŸä»»åŠ¡

ç¤ºä¾‹ä»£ç 

```java
package schedule;

import java.util.Date;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

public class ScheduledExecutorTest {
    

	public static void main(String[] a) throws Exception
	{
		//executeAtFixTime();
		//executeFixedRate();  //3s
		executeFixedDelay();  //4s
	}
	
	public static void executeAtFixTime() throws Exception {
	    ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
	    executor.schedule(
	            new MyTask(),
	            1,                
	            TimeUnit.SECONDS);
	    
	    Thread.sleep(20000);
	    executor.shutdown();
	}
	
	/**
	 * å‘¨æœŸä»»åŠ¡ å›ºå®šé€Ÿç‡ æ˜¯ä»¥ä¸Šä¸€ä¸ªä»»åŠ¡å¼€å§‹çš„æ—¶é—´è®¡æ—¶ï¼Œperiodæ—¶é—´è¿‡å»åï¼Œæ£€æµ‹ä¸Šä¸€ä¸ªä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œ
	 * å¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™å½“å‰ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™éœ€è¦ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åç«‹å³æ‰§è¡Œã€‚
	 * @throws Exception 
	 */
	public static void executeFixedRate() throws Exception {
	    ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
	    executor.scheduleAtFixedRate(
	            new MyTask(),
	            1,
	            3000,
	            TimeUnit.MILLISECONDS);
	    
	    Thread.sleep(20000);
	    executor.shutdown();
	}
	
	/**
	 * å‘¨æœŸä»»åŠ¡ å›ºå®šå»¶æ—¶ æ˜¯ä»¥ä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸæ—¶å¼€å§‹è®¡æ—¶ï¼Œperiodæ—¶é—´è¿‡å»åï¼Œç«‹å³æ‰§è¡Œã€‚
	 * @throws Exception 
	 */
	public static void executeFixedDelay() throws Exception {
	    ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
	    executor.scheduleWithFixedDelay(
	            new MyTask(),
	            1,
	            3000,
	            TimeUnit.MILLISECONDS);
	    
	    Thread.sleep(20000);
	    executor.shutdown();
	}    

}

class MyTask implements Runnable {
	public void run() {
		System.out.println("æ—¶é—´ä¸ºï¼š" + new Date());
		try {
			Thread.sleep(1000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		//System.out.println("æ—¶é—´ä¸ºï¼š" + new Date());
	}
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

executeAtFixTime()

![image-20210721154111899](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721154111899.png)

executeFixedRate()

![image-20210721154122696](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721154122696.png)

executeFixedDelay()

![image-20210721154131415](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721154131415.png)



### Quartz

- Quartzæ˜¯ä¸€ä¸ªè¾ƒä¸ºå®Œå–„çš„ä»»åŠ¡è°ƒåº¦æ¡†æ¶
- è§£å†³ç¨‹åºä¸­Timeré›¶æ•£ç®¡ç†çš„é—®é¢˜
- åŠŸèƒ½æ›´åŠ å¼ºå¤§
- Timeræ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œå¦‚æœä¸­é—´æŸä¸€æ¬¡æœ‰å¼‚å¸¸ï¼Œæ•´ä¸ªä»»åŠ¡ç»ˆæ­¢æ‰§è¡Œ
- Quartzæ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œå¦‚æœä¸­é—´æŸä¸€æ¬¡æœ‰å¼‚å¸¸ï¼Œä¸å½±å“ä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œ
  

**ç¤ºä¾‹ä»£ç **

```java
package quartz;

import org.quartz.JobDetail;
import org.quartz.Scheduler;
import org.quartz.Trigger;
import org.quartz.impl.StdSchedulerFactory;

import static org.quartz.JobBuilder.newJob;
import static org.quartz.SimpleScheduleBuilder.simpleSchedule;
import static org.quartz.TriggerBuilder.newTrigger;

public class QuartzTest {

    public static void main(String[] args) {
        try {
            //åˆ›å»ºscheduler
            Scheduler scheduler = StdSchedulerFactory.getDefaultScheduler();
    
            //å®šä¹‰ä¸€ä¸ªTrigger
            Trigger trigger = newTrigger().withIdentity("trigger1", "group1") //å®šä¹‰name/group
                    .startNow()//ä¸€æ—¦åŠ å…¥schedulerï¼Œç«‹å³ç”Ÿæ•ˆ
                    .withSchedule(simpleSchedule() //ä½¿ç”¨SimpleTrigger
                            .withIntervalInSeconds(2) //æ¯éš”2ç§’æ‰§è¡Œä¸€æ¬¡
                            .repeatForever()) //ä¸€ç›´æ‰§è¡Œ
                    .build();
    
            //å®šä¹‰ä¸€ä¸ªJobDetail
            JobDetail job = newJob(HelloJob.class) //å®šä¹‰Jobç±»ä¸ºHelloQuartzç±»
                    .withIdentity("job1", "group1") //å®šä¹‰name/group
                    .usingJobData("name", "quartz") //å®šä¹‰å±æ€§
                    .build();
    
            //åŠ å…¥è¿™ä¸ªè°ƒåº¦
            scheduler.scheduleJob(job, trigger);
    
            //å¯åŠ¨
            scheduler.start();
    
            //è¿è¡Œä¸€æ®µæ—¶é—´åå…³é—­
            Thread.sleep(10000);
            scheduler.shutdown(true);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

}

package quartz;

import org.quartz.Job;
import org.quartz.JobDetail;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;

import java.util.Date;

public class HelloJob implements Job {
    public void execute(JobExecutionContext context) throws JobExecutionException {
        JobDetail detail = context.getJobDetail();
        String name = detail.getJobDataMap().getString("name");
        System.out.println("hello from " + name + " at " + new Date());
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-20210721154217935](C:\Users\bhy\AppData\Roaming\Typora\typora-user-images\image-20210721154217935.png)



